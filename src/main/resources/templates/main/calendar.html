<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>

    <meta charset='utf-8' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/locales-all.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">

    <script th:inline="javascript">
        // var calList = [[${calData}]];
        // var calList2 = [[${session}]];
        // console.log("model" + calList[0][title]);
        // console.log("session" + calList2);
        var calendar = null;
        document.addEventListener('DOMContentLoaded', function() {
        var calendarEl = document.getElementById('calendar');

        calendarObect = {
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay'
            },
            // initialDate: '2023-01-12',
            navLinks: true, // can click day/week names to navigate views
            selectable: true,
            selectMirror: true,
            locale: 'ko',
            select: function (arg) {
                var title = prompt('Event Title:');
                if (title) {
                    console.log(arg.start);
                    console.log(arg.end);

                    let obj = {
                        title: title,
                        start: arg.start,
                        end: arg.end,
                        allDay: arg.allDay
                    }
                    save_data(obj);
                    // calendar.addEvent({
                    //
                    //     title: title,
                    //     start: arg.start,
                    //     end: arg.end,
                    //     allDay: arg.allDay
                    // })
                }
                calendar.unselect()
            },
            eventClick: function (arg) {
                if (confirm('Are you sure you want to delete this event?')) {
                    arg.event.remove() // 여기서 리무브를 시키면 안되고 db에 삭제를 시켜야 한다.
                }
                console.log(arg.event);
                let events = new Array();
                let obj = {
                    title: arg.event._def.title,
                    start: arg.event._instance.range.start
                };

                delete_data(obj);
            },

            eventDrop: function(info) {
                //드래그 수정
                let obj = {
                    // 이건 수정된 정보
                    title: info.event._def.title,
                    start: info.event._instance.range.start,
                    end: info.event._instance.range.end
                }

                let oldObj = {
                    title: info.oldEvent._def.title,
                    start: info.oldEvent._instance.range.start,
                    end: info.oldEvent._instance.range.end
                }
                // console.log(info)
                // console.log(obj)
                // console.log(oldObj)
                update_data(obj, oldObj);

            },
            editable: true,
            dayMaxEvents: true, // allow "more" link when too many events
            events: function (info, successCallback, failureCallback) {
                $.ajax({
                    url: '/set',
                    type: 'post',
                    dataType: 'json',
                    success: function (data) {
                        successCallback(data);
                    },
                    error: function (error) {
                        console.log(error)
                    }
                })
            }
        }


            calendar = new FullCalendar.Calendar(calendarEl, calendarObect);

            calendar.render();
            });


            // 이거 못 쓰겠네..
            // function get_data() {
            //     let allEvents = calendar.getEvents();
            //     let eventArr = new Array();
            //
            //     console.log(allEvents);
            //
            //     for (let i = 0; i < allEvents.length; i++) {
            //     let obj = {
            //     title : allEvents[i]._def.title,
            //     start : allEvents[i]._instance.range.start,
            //     end : allEvents[i]._instance.range.end,
            //     allDay: allEvents[i]._def.allDay
            //     }
            //     // save_data(obj);
            //     eventArr.push(obj);
            //     }
            //     // console.log(eventArr)
            //     save_data(eventArr);
            // }

            function save_data(obj) {
                $.ajax({
                    type: 'post',
                    url: '/save',
                    data: JSON.stringify(obj),
                    dataType: 'json',
                    contentType: "application/json",
                    success: function (data) {

                    },
                    error: function (error) {

                    }
                })
                location.reload();
            }

            function delete_data(obj) {
                $.ajax({
                    type: 'post',
                    url: '/delete',
                    data: JSON.stringify(obj),
                    dataType: 'json',
                    contentType: "application/json",
                    success: function (data) {
                        alert("성공")
                    },
                    error: function (error) {
                        alert("실패");
                    }
                })
            }

            function update_data(obj, oldObj) {
                console.log(obj)
                console.log(oldObj)
                let objList = [obj, oldObj]
                $.ajax({
                    url: "/update",
                    type: 'post',
                    data: JSON.stringify(objList),
                    dataType: 'json',
                    contentType: "application/json",
                    success: function (data) {

                    },
                    error: function (error) {
                        console.log(error)
                    }
                })
            }


    </script>
    <style>
        *{
            font-family: 'Jua', sans-serif;
        }

        body {
            margin: 40px 10px;
            padding: 0;
            font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
            font-size: 14px;
        }

        #calendar{
            width: 1100px;
        }

        #user{
            top: 30px;
            padding: 0;
            width: 200px;
            height: 350px;
            margin-top: 70px;
            background-color: cornsilk;
            border-radius: 5px;
            border: 1px solid black;
        }

        #list1, #list2{
            margin-top: 35px;
            padding: 0;
            width: 200px;
            height: 350px;
            background-color: cornsilk;
            border-radius: 5px;
            border:1px solid black;

        }
        main{
            display: flex;
            justify-content: space-between;
        }

        section{
            position: relative;
            display: flex;
            flex-direction: column;
            font-family: Arial, Helvetica Neue, Helvetica, sans-serif;

        }

        #userPhoto{
            /*background-image: url("야옹이.jpg");*/
            width: 180px;
            background-color: aquamarine;
            height: 230px;
            margin: 0 auto;
            top: 0;

            border-radius: 5px;
            background-size: cover;
            background-position: center;
        }

        button{
            width: 90px;
            background-color: rgba(15, 42, 56, 80%);
            color: white;
        }

        button:hover{
            background-color: #f6dade;
            color: black;
        }

        #buttons{
            display: flex;
            margin: 5px 5px;
            padding: 5px 5px;
        }

        button + button{
            margin-left: 10px;
        }


        ul{
            width: 180px;
            height: 30px;
            background-color: rgba(161, 161, 161, 30%);
            margin: 5px 5px;
            border-radius: 5px;
            padding: 5px;
            text-align: center;
        }


        div{
            text-align: center;
        }

        #leftInfo{
            height: 900px;
            margin-right: 50px;
            font-family: 'Jua', sans-serif;
            font-size: large;
        }
        main{
            margin: 0 auto;
            display: flex;
            justify-content: center;
        }

        #profile_id{
            font-size: 1.8rem;
        }

        #profile_word{
            font-size: 1rem;
        }


        .list_name{
            margin: 5px 5px;
            background-color: rgba(209, 239, 255, 0.8);

        }

        #add{
            width: 190px;
            bottom: 5px;
            position: absolute;
            left: 5px;
        }

        #list2{
            position: relative;
            display: inline-block;
        }

        .lists{
            scrollbar-width: none;
            height: 180px;
            overflow: scroll;
            overflow-y: auto;
            -ms-scroll-snap-type: none;
            padding: 0 0;
        }

        .lists::-webkit-scrollbar-thumb{
            height: 180px;
            background-color: transparent;
        }

        .lists::-webkit-scrollbar-track {
            background-color: transparent;
        }

        .lists::-webkit-scrollbar{
            width: 0;
        }

    </style>
</head>
<body>
<main>
    <section id="leftInfo">
        <div id="user">
            <div><span id="profile_id" th:text="${session.loginedUser.getId()}"></span><span id="profile_word"> 님, 환영합니다</span></div>
            <div id="userPhoto"></div>
            <div id="buttons">
                <button>로그인</button>
                <button>회원가입</button>
            </div>
        </div>
        <div id="list1">
            <div class="list_name">개인</div>
            <div class="lists">
                <ul>프로젝트 완성</ul>
                <ul>토요일 회식</ul>
                <ul>영화 보러가기</ul>
            </div>
        </div>
        <div id="list2">
            <div class="list_name">그룹</div>
            <div class="lists">
                <ul th:each="belongGroup : ${belongGroup}" th:text="${belongGroup}"></ul>
            </div>
            <button id="add">그룹 생성하기</button>
        </div>

    </section>

    <div id='calendar'></div>
</main>
</body>
</html>

